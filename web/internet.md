# 互联网

互联网（Internet）是遍布全球的一套网络设施，它由主机、路由器、交换机、传输介质等设备组成，不同设备间的连接遵循互联网协议套件（Internet Protocol Suite，IPS，也叫做TCP/IP协议族，TCP/IP Protocols）的规定。它由无数个小网络连接而成——每个家庭有各自的家庭网络，若干家庭网络相连形成覆盖整栋楼房的网络，这些网络再进一步连接，直至全球网络相连，构成互联网。因此，互联网也称作“**网络的网络**”

互联网只有一个，世界上其他网络都不能称作互联网。电话网络、工业以太网等网络不使用TCP/IP协议，独立于互联网之外；独立内网（如保密单位的内部网络）虽然使用TCP/IP协议，但未接入互联网，也是独立网络；家庭网络、学校网络等局域网使用TCP/IP协议，也可以与互联网通信，但只是互联网的一小部分

## 分组交换

### 简介

互联网使用**分组交换**（Packet Switching）技术通信，此技术是互联网的基石。从历史的角度来看，交换技术经过了以下演变：

1. **电路交换**（Circuit Switching）：开始通信前，双方要建立点对点的信号通道。比如老式电话网络中，用户拨号之后，接线员（或者后来一点的程控交换机）将拨号者的电话线连接到收听者的电话线，然后拨号者与接听者才能通话
2. **报文交换**（Message Switching）：双方无需建立完整通信链路，发送者将信息转发给路由（即“中转站”），路由将信息转发给下一个路由，再下一路由，直到消息传达给接收方，过程类似于快递运输
3. **分组交换**（Packet Switching）：在报文交换的基础上，将数据拆分为若干分组（Packet）分别传输
   - 与电路交换相比：电路交换在空闲时（例如发出信息后等待回复）也要维持完整信号通道，浪费了部分带宽，而分组交换可以将这部分带宽用于和其他设备通信。不过分组交换也有时延不可控、易丢包的缺点
   - 与报文交换相比：使用报文交换传输大文件时，若占用全部带宽，则其他用户无法使用网络；若使用部分带宽（频分复用、时分复用等），则具有了电路交换的全部缺点。报文交换作为分组交换的前身，在分组交换技术出现后迅速被淘汰了

如今，分组交换是主流的交换技术，但在某些场景（需要稳定连接、固定流量等）电路交换有优势。也有尝试将两者混合，使用分组交换的同时又具有一定电路交换的特性

### 时延，丢包和吞吐量

时延，从源主机开始发送到目标主机完成接收所花费的时间，是以下四部分之和：

- **处理时延**（Processing Delay）：处理数据包、查找路由表的时间。通常是微秒量级
- **排队时延**（Queuing Delay）：等待传输的时间，取决于流量强度。微秒到毫秒量级
- **传输时延**（Transmission Delay）：发送数据所需时间，如网速为100 Mbps，传输10 Mb的数据，传输时延为0.1s
- **传播时延**（Propgation Delay）：信号传播的时间，取决于路由器之间举例，可用“一米5纳秒”估算，局域网传播时延可忽略，广域网为毫秒量级



## 互联网协议套件

互联网协议套件，是一系列网络传输协议的集合，它们是现代网络通讯的通用标准

### TCP/IP参考模型

TCP/IP协议族将网络通信按照功能，从上到下划分为应用层、传输层、网络层、链接层，并定义了每一层的功能。分层模型让每一层独立工作，不需要担心其他层级的问题。下表总结类每层的作用、常见协议等

| 层                        | 作用 | 常见协议             | 数据单位        |
| ------------------------- | ---- | -------------------- | --------------- |
| 应用层，Application Layer |      | HTTP，DNS，SMTP，FTP | 报文（Message） |
| 传输层，Transport Layer   |      | TCP，UDP             | 段（Segment）   |
| 网络层，Internet Layer    |      | IP，ICMP，ARP        | 包（Packet）    |
| 链路层，Link Layer        |      | 以太网，Wi-Fi        | 帧（Frame）     |

需要注意，这只是“参考”模型，协议并不是严格按照这个模型设计的，比如ICMP协议工作于网络层，但它不需要传输层协议，直接与应用层对接

大部分教材和课程都是从上往下讲的，我觉得不妥，链路、网络都没有理解，就开始讲传输、应用，这不是空中楼阁吗？比较理想的学习顺序应该是先从下往上快速过一遍，再从上往下仔细学

## OSI模型

OSI模型是国际标准化组织提出的分层方案，它的划分如下表

| 层号 | 名称                          | 作用 |
| ---- | ----------------------------- | ---- |
| 7    | 应用层（Application Layer）   |      |
| 6    | 表示层（Presentation Layer）  |      |
| 5    | 会话层（Session Layer）       |      |
| 4    | 传输层（Transport Layer）     |      |
| 3    | 网络层（Network Layer）       |      |
| 2    | 数据链路层（Data Link Layer） |      |
| 1    | 物理层（Physical Layer）      |      |

OSI模型比TCP/IP参考模型分层更严格，功能更完善。因此需要分析协议 / 网络设备的作用时往往采用OSI模型。不过，严格和功能完善的代价是降低了灵活性，还增添了不必要的复杂度，因此绝大多数协议的还是根据TCP/IP参考模型设计

时刻注意，OSI模型和TCP/IP参考模型终究是两个东西，要避免混淆。我的分辨经验是：涉及链路层的论述往往是OSI模型，因为TCP/IP参考模型链路层比较混乱；只涉及传输层、网络层的论述不必费心分辨，因为OSI模型3、4层和TCP/IP参考模型的2、3层几乎完全对应；使用数字编号的可以通过结合各层作用分辨

本笔记中的层，若无说明，均指TCP/IP参考模型的层

# 链路层

链路层负责在以太网、Wi-Fi等局域网内实现设备间的数据传输。以以太网为例：

1. 发送端将数据封装为以太网帧（其中包括了源和目标的MAC地址）
2. 将数据帧发送到交换机
3. 交换机根据MAC地址表转发至接收端

TCP/IP协议组不太关注这一层，它的作用也一直有点模糊。不过，通过MAC地址通讯的协议都可以当作是这一层，无需纠结，It just works

# 网络层

网络层负责不同局域网之间的数据传输，网络层常用协议有IP（核心协议）、ICMP（网络诊断，如ping）、RIP和OSPF等内部网关协议。以下面的网络结构为例，某单位有A、B两栋楼，A栋的设备都接入路由交换机A1，组成局域网A；B栋设备都接入路由交换机B1，组成局域网B；A1和B1接入交换机0

```
                +--------+
                | 交换机0 |
                +--------+
                    |
        +-----------+------------+
        |                        |
 +-------------+          +-------------+
 | 路由交换机A1 |          | 路由交换机B1 |
 +-------------+          +-------------+
        |                        |
+---------------+        +---------------+
| 主机A2, A3... |        | 主机B2, B3... |
+---------------+        +---------------+
```

此网络系统中，局域网A的设备之间可以用链路层协议通信，局域网B的设备之间也可以。但两个局域网之间的通信就需要网络层协议了，以A2、B2两设备通信为例，

1. A2判断B2不在局域网内，因此将数据包发给网关（局域网与其他网络的连接点），即A1
2. A1计算连接到局域网B的最优路径——结果是发给B1，于是将数据包发给B1
3. B1通过链路层协议将数据包发给B2

步骤1中主机判断目标是否在同一局域网、步骤2中计算通往目标局域网的路径，这就是网络层的两个主要功能：寻址和路由

### IP

IP协议全程网际协议（Internet Protocol），是网络层的核心。

#### IP地址

IP协议为每个网络设备分配IP地址作为标识符。IP地址有IPv4和IPv6版本，前者长度为32比特，通常用点分十进制表示，如`127.0.0.1`；后者长度为128比特，通常用冒分16进制表示，如`fe80:0:0:0:7d6f:979c:3a86:80b5`，连续多段为0的部分可以省略并用`::`表示，所以此地址也可以写作`fe80::7d6f:979c:3a86:80b5`

**子网划分**

IP地址数量众多，需要划分给众多机构 / 公司 / 个人管理，划分后较小的网络称作子网，IP段或者网段。划分子网的工具是**子网掩码**，它是一个32比特的数，`IP地址 & 子网掩码`相同的地址处于同一个子网。子网常用以下两种记法：

- CIDR表示法：`IP地址/子网掩码长度`，如`14.15.0.0/16`
- 点分十进制表示法：分别记录IP地址和子网掩码的值，如IP地址`14.15.0.0`，子网掩码`255.255.0.0`

**分层授权**

IP地址由多个机构分层授权分配。按照层级从高到低，分别是

1. **IANA → RIR**：IANA（互联网号码分配局，Internet Assigned Numbers Authority）将IP地址分配给各地区的RIR（区域互联网注册机构，Regional Internet Registry）。例如`14.0.0.0/8`IP段分给了亚太地区RIR
2. **RIR → ISP**：RIR将地址分配给各ISP（互联网服务供应商，Internet Service Provider），如亚太地区RIR从`14.0.0.0/8`拆分出`14.144.0.0/12`分配给中国电信
3. **ISP → 用户**：例如中国电信将IP地址分配给用户

不同主机的IP地址不可重复，如果试图绕过这个体系，手动设置一个未授权的IP地址，会使路由无法正常转发，导致网络不通

#### 寻址

IP地址分层授权机制告诉我们，从IP地址可以定位到主机的物理地址，此过程称作寻址。例如，地址`14.153.6.1`的分配过程是：IANA首先将`14.0.0.0/8`分配给亚太地区，亚太地区的RIR从中拆分出`14.144.0.0/12`分配给中国电信，中国电信从中进一步拆出`14.153.0.0/16`分给某个省……各环节IP地址分配给谁一般不是秘密，知道IP地址基本可以轻松定位到所在城市，技术和权限足够的话直接定位到一个房间也不困难

从寻址过程也不难发现，如果从头开始逐比特比较两个IP地址，匹配的位数越多，就说明两台主机物理地址越近：匹配8~12比特，说明它们都在亚太地区；匹配12~16位，它们都在中国；匹配16位以上，说明它们在同一个省

#### 路由

主机与其他设备通讯时，若源IP地址和目标IP地址在不在同一个子网，就不能直接发送，需要中间设备转发。转发可能有多种路径，选取传输路径的过程称作路由（Routing）

选取传输路径的策略存储在路由设备中，称作路由表。例如，路由表记录了`目标地址: 14.153.0.0/16 下一跳: 14.78.1.1`，当此路由器收到一个目的地是`14.153.0.0/16`的数据包时，就将它转发到`14.78.1.1`

IP协议规定了使用路由表选择转发路径，但没有规定怎么建立路由表。路由表的建立、维护还要依靠OSPF，BGP等协议

# 传输层

传输层负责通讯的可靠性（比如校验数据是否损坏或丢失）、流量控制等。常用协议有TCP和UDP

### TCP

1. 三次握手，验证双工通信，让另一端准备接收数据，并初始化序列号等参数
2. 将报文分割为大小合适的数据包
3. 在每个数据包开头加上TCP头，包括：
   - 源端口和目的端口：标识数据包由哪个应用程序发送、哪个应用程序接收
   - 序列号（Sequence Number）：该数据包是第几个字节
   - 确认号（Acknoledgement Number）：在应答报文中使用，详见下一段
   - 校验和：检验数据有没有损坏
   - 头部长度、数据长度、标志位等
4. 将封装好的数据帧传递给网络层
5. 数据传完后，四次挥手中止连接

另一端收到TCP报文后，回复确认包告知发送方收到了哪些数据包，比如确认号为1000，表示第1000字节之前的数据都收到了，请求发送方从序列号发送序列号1000的数据帧

发送方如果重复收到同一个确认号（一般是3次）就重传这个包，此机制称作**重复累计确认**（Duplicate Cumulative Acknoledgements）。形象地理解，假设一个包100字节，发送方发了5000字节，但接收方说只收齐了前1000字节，那就说明1001~1100字节发丢了，需要重发。重复确认是为了防止乱序包导致无作用重传，比如因为网络延迟，接收端先收到1101~1200字节，回复确认号1001的包，再收到1001~1100字节，这种情况下发送方收到此回复并不表示1001~1100字节传丢了

发送方如果间隔很久都没收到确认包，就认为上一个确认包之后的数据都发丢了，重传这些数据包。此机制称**超时重传**。为了防止DoS攻击，连续超时的情况下，会延长超时阈值

### UDP

发送过程和TCP协议类似。只不过，UDP头只有源端口、目的端口、数据帧长度、校验和。接收端收到数据包后不回报，即使传丢了发送方也不知道，更不会自动重传

# 应用层

应用层的主要作用是定义数据格式，以实现特定业务。比如HTTP协议规定了报文格式，以及收到报文后应如何处理。常见协议有HTTP（网页传输）、DNS（域名解析）、SMTP（邮件收发）、FTP（文件传输）等

### DNS

# 其他

- **NAT**（网络地址转换，Network Address Translation）

NAT可以让多台设备共用一个IP地址，把有限的IPv4地址分配给更多设备。它的工作原理是将内网地址映射到公网地址，例如，某路由器的公网IP地址为`203.0.113.5`；一台电脑连接到此路由器，其内网IP地址为`102.168.1.1`；路由器NAT表中记录了映射信息`192.168.1.1:5000 -> 203.0.113.5:6000`。电脑通过浏览器访问网页，发出数据包中的源地址、端口为`192.168.1.1:5000`。数据包经过路由器时，路由器将数据包中的源地址、端口改为`203.0.113.5:6000`，发送至目标服务器。服务器返回响应时，将目标地址从`203.0.113.5:6000`还原为`192.168.1.1:5000`，数据包正确送达电脑
