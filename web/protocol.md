# 互联网协议套件概述

互联网协议套件（Internet Protocol Suite，IPS）也叫做TCP/IP协议族（TCP/IP Protocols），是一系列网络传输协议的集合，它们是现代网络通讯的基石

## TCP/IP参考模型

TCP/IP协议族将网络通信按照功能，从上到下划分为应用层、传输层、网络层、链接层，并定义了层间的接口格式。这样，每一层确实只需对上下两层负责

| 层     | 作用 | 常见协议             | 数据单位        |
| ------ | ---- | -------------------- | --------------- |
| 应用层 |      | HTTP，DNS，SMTP，FTP | 报文（Message） |
| 传输层 |      | TCP，UDP             | 段（Segment）   |
| 网络层 |      | IP，ICMP，ARP        | 包（Packet）    |
| 链接层 |      |                      | 帧（Frame）     |



# 应用层

常见协议有HTTP（网页传输）、DNS（域名解析）、SMTP（邮件收发）、FTP（文件传输）等

# 传输层

常用协议有TCP和UDP。传输层负责通讯的可靠性（比如校验数据是否损坏或丢失）、流量控制等

## TCP

1. 三次握手，验证双工通信，让另一端准备接收数据，并初始化序列号等参数
2. 将应用层传来的报文分割为大小合适的数据包
3. 在每个数据包开头加上TCP头，包括：
   - 源端口和目的端口：标识数据包由哪个应用程序发送、哪个应用程序接收
   - 序列号（Sequence Number）：该数据包是第几个字节
   - 确认号（Acknoledgement Number）：在应答报文中使用，详见下一段
   - 校验和：检验数据有没有损坏
   - 头部长度、数据长度、标志位等
4. 将封装好的数据帧传递给网络层
5. 数据传完后，四次挥手中止连接

另一端收到TCP报文后，回复确认包告知发送方收到了哪些数据包，比如确认号为1000，表示第1000字节之前的数据都收到了，请求发送方从序列号发送序列号1000的数据帧

发送方如果重复收到同一个确认号（一般是3次）就重传这个包，此机制称作**重复累计确认**（Duplicate Cumulative Acknoledgements）。形象地理解，假设一个包100字节，发送方发了5000字节，但接收方说只收齐了前1000字节，那就说明1001~1100字节发丢了，需要重发。重复确认是为了防止乱序包导致无作用重传，比如因为网络延迟，接收端先收到1101~1200字节，回复确认号1001的包，再收到1001~1100字节，这种情况下发送方收到此回复并不表示1001~1100字节传丢了

发送方如果间隔很久都没收到确认包，就认为上一个确认包之后的数据都发丢了，重传这些数据包。此机制称**超时重传**。为了防止DoS攻击，连续超时的情况下，会延长超时阈值

## UDP

发送过程和TCP协议类似。只不过，UDP头只有源端口、目的端口、数据帧长度、校验和。接收端收到数据包后不回报，即使传丢了发送方也不知道，更不会自动重传

# 网络层

网络层负责寻址和路由。常用协议有IP（核心协议）、ICMP（网络诊断，如ping）、ARP（IP地址到mac地址的映射）

## IP

IP协议全程网际协议（Internet Protocol），是网络层的主要协议。IP头包括源IP地址、目标IP地址、报头长度、数据包长度等。

# IP地址

每台设备在连接到网络上时都会分配IP地址，它的作用是标识主机

IPv4协议使用4个字节的数据作为地址，通常用点分十进制表示，如`127.0.0.1`

## 地址分配

IP地址采用分层授权体系分配。按照层级从高到低，分别是

1. **IANA → RIR**：IANA（互联网号码分配局，Internet Assigned Numbers Authority）将IP地址分配给各地区的RIR（区域互联网注册机构，Regional Internet Registry）。例如`14.0.0.0/8`IP段分给了亚太地区RIR
2. **RIR → ISP**：RIR将地址分配给各ISP（互联网服务供应商，Internet Service Provider），如亚太地区RIR从`14.0.0.0/8`拆分出`14.144.0.0/12`分配给中国电信
3. **ISP → 用户**：中国电信将IP地址分配给用户

如果试图绕过这个体系，手动设置一个越权的IP地址，会使路由工作不正常，导致网络不通

### 分类网络

- **简介**

分类网络将IP地址分为A类~E类，它们以前缀（地址前几个比特）区分，例如IP地址`36.0.0.1`，最高位为`0b0`，因此属于A类地址。A类地址的网络地址位数为8，也就是说IP地址前8比特`36`是网络地址、后24比特`0.0.1`是主机地址

各类地址的前缀、网络地址位数如下表（注：网络数和最大主机数计算均未扣除保留地址，如`127.0.0.1`。实际可分配的IP地址数目比表格中的数字稍少一点）

| 类别 | 前缀     | 网络地址位数 | 网络数               | 单个网络内最大主机数  | 用途               |
| ---- | -------- | ------------ | -------------------- | --------------------- | ------------------ |
| A类  | `0b0`    | 8            | $2^7 = 128$          | $2^{24} = 16,777,214$ | 超大型机构         |
| B类  | `0b10`   | 16           | $2^{14} = 16384$     | $2^{16} = 65536$      | 中型企业，大学     |
| C类  | `0b110`  | 24           | $2^{21} = 2,097,152$ | $2^8 = 256$           | 小型公司，家庭网络 |
| D类  | `0b1110` | 未定义       |                      |                       | 组播网络           |
| E类  | `0b1111` | 未定义       |                      |                       | 保留               |

- **子网划分**（Subnetting）

分类网络欠缺灵活性，例如，某企业需要给约2000台主机分配IP地址，申请C类网络不够用，B类网络则会浪费六万多个地址。将一个大网络划分为多个较小的子网络，可以减少浪费。划分时需要设置子网掩码，例如设置为`255.255.0.0`，前16比特是1，后16比特为0，表示IP地址前16位为子网号。例如，A类网络`77.x.x.x`网络号为`77`。设置上述子网掩码后，子网号为`77.x`，一个A类网络被划分为`77.1.x.x`、`77.2.x.x`、……、`77.255.x.x`共256个子网络

CIDR技术引入之前，使用的是定长子网掩码（Fixed Length Subnet Mask，FLSM），一个网络内必须使用相同长度的子网掩码，灵活性仍不足

- **分配规则**

我没有详细考究，本段是基于我的理解和部分史料（如[RFC 790](https://datatracker.ietf.org/doc/html/rfc790)记载了1981年的IP地址分配）推测的。互联网黎明期的IP地址分配流程很可能是：用户向IP地址管理机构申请网络号，获得网络号后自行分配该网络内的IP地址。例如，某企业申请了C类网络`201.1.2.x`，就可以自行组网，自由分配该网络的两百多个IP地址

互联网用户激增，引入子网划分之后，我估计这时候分配机制已经很发达了，可能是管理机构把网络地址授权给运营商，运营商拆分子网并分配给用户

### CIDR

- **简介**

全称无类别域间路由（Classless Inter-Domain Routing）。CIDR规定用IP地址和子网掩码长度标识地址，如`143.16.0.0/18`。其中斜杠前为IP地址，斜杠后的18表示子网掩码前18比特为1、后6比特位0，即子网掩码`255.255.192.0`。

CIDR技术采用可变长子网掩码，彻底抛弃了分类网络（这就是名字中“无类别”的含义）

- **NAT**（网络地址转换，Network Address Translation）

NAT可以让多台设备共用一个IP地址，把有限的IPv4地址分配给更多设备。它的工作原理是将内网地址映射到公网地址，例如，某路由器的公网IP地址为`203.0.113.5`；一台电脑连接到此路由器，其内网IP地址为`102.168.1.1`；路由器NAT表中记录了映射信息`192.168.1.1:5000 -> 203.0.113.5:6000`。电脑通过浏览器访问网页，发出数据包中的源地址、端口为`192.168.1.1:5000`。数据包经过路由器时，路由器将数据包中的源地址、端口改为`203.0.113.5:6000`，发送至目标服务器。服务器返回响应时，将目标地址从`203.0.113.5:6000`还原为`192.168.1.1:5000`，数据包正确送达电脑

- **分配规则**



### IPv6地址



## 路由

