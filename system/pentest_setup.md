# 安装CA证书

CA证书是数字证书认证机构（Certificate Authority）颁发的电子证书，一般特指SSL/TLS证书。设备与服务器建立SSL/TLS连接时，需要验证证书有效性：

1. 设备请求服务器`example.com`，服务器发回服务器证书、签发证书的CA机构信息
2. 设备比对服务器证书、本地信任库，若匹配到了则信任此服务器
3. 若未匹配到，则向签发证书的CA机构服务器发起请求，CA服务器发回自己的证书、上级CA机构信息
4. 用和第二步相同的方法判断此CA服务器是否可信，若可信，则与它建立连接，询问`example.com`是否可信；若不可信，则重复3-4，请求再上一级的CA服务器
5. 若最终判断结果是`example.com`可信，就与它继续建立连接；否则，中止SSL连接

想要用代理抓包时需要手动添加“不安全”的证书以获取传输数据

- Linux：base64编码的文本，后缀`.pem`，`.crt`，`.key`
- Windows：二进制文件，后缀`.der`，`.cer`
- Android：两种格式都行，但是文件名要改为`PEM格式证书哈希值.0`

格式转换：

```shell
# pem转der。反之同理
openssl x509 -in cert.crt -inform pem -out cert.der -outform der
# 计算哈希值
openssl x509 -in cert.pem -inform PEM -subject_hash
```

## Windows



## Linux

```bash
sudo cp cacert.crt /usr/local/share/ca-certificates  # 复制到系统证书目录
sudo update-ca-certificates                          # 安装证书

# 检查证书是否成功安装
cat cacert.crt   # 查看证书内容，复制密钥的一部分
sudo cat /etc/ssl/certs/cacert.crt | grep L4zOd3  # 查找刚才复制的一小段。若有结果则安装完成
```

## Android

- **Android 7前**：用户证书和系统证书有相同权限，直接安装为用户证书即可
- **Android 7-13**：用户证书和系统证书分开，系统证书存储于`/system/etc/security/cacerts`。但是普通用户没有访问system目录的权限，root用户也可能没有写system目录的权限
- **Android 14后**：系统证书除了system盘，还安装在`/apex/com.android.conscrypt/cacerts`，由apex机制管理

### 添加证书

**方法1**：adb获取root权限，直接操作系统证书目录。不过adb可能无法获得足够的权限

```shell
adb root
adb remount
adb push 9a5ba575.0 /system/etc/security/cacerts/
```

**方法2**：在adb shell获取超级用户权限，将系统盘改为可写，并写入证书。如果尝试了全部获取权限命令复制时仍然显示“Read-only file system”，那么system盘可能使用了EROFS等只读文件系统

```shell
# 获取super user权限。可能需要在手机上点确认。若shell的$变为#说明成功
su
# 获取写系统分区权限。不同系统需要的命令不同，建议逐一尝试
mount -o rw,remount /system
mount -o rw,remount /
chmod 777 /system
# 将证书复制到系统证书目录
cp /sdcard/Download9a5ba575.0 /system/etc/security/cacerts/
```

**方法3**：magisk加载模块：首先[安装magisk](./android.md#magisk)，安装[MoveCertificate模块](https://github.com/ys1231/MoveCertificate)，将证书复制到`/data/local/tmp/cert`，重启手机即可生效

**其他**：没有测试过，上面的方法都用不了的时候可以考虑

- DNA修改system.img：使用安卓固件解包打包工具[DNA](https://github.com/ColdWindScholar/D.N.A3)，修改system.img映像并重新刷入
- [HTTP Toolkit](https://httptoolkit.com/docs/guides/android/)工具抓包，原理似乎是挂载了一个内存文件系统，参考[这篇文章](http://91fans.com.cn/post/certificate/)

```shell
# 将系统证书复制到临时文件夹
mkdir -m 700 /data/local/tmp/htk-ca-copy
cp /system/etc/security/cacerts/* /data/local/tmp/htk-ca-copy/
# Create the in-memory mount on top of the system certs folder
mount -t tmpfs tmpfs /system/etc/security/cacerts
# 将系统证书、要添加的证书复制到内存文件系统
mv /data/local/tmp/htk-ca-copy/* /system/etc/security/cacerts/
cp /data/local/tmp/c88f7ed0.0 /system/etc/security/cacerts/
# Update the perms & selinux context labels, so everything is as readable as before
chown root:root /system/etc/security/cacerts/*
chmod 644 /system/etc/security/cacerts/*
chcon u:object_r:system_file:s0 /system/etc/security/cacerts/*
```

# VMWare

## 网络设置

在安装 VMware 之后，宿主机上会出现几个相关的虚拟设备，可以在编辑 - 虚拟网络编辑器配置。虚拟机连接网络有三个方式，在虚拟机 - 设置 - 网络适配器配置

- 桥接：虚拟机连接到虚拟交换机VMnet0，相当于一台独立的主机接入局域网
- NAT：连接到虚拟网卡VMnet8，通过NAT与外部设备通信，外部设备无法访问虚拟机
- 仅主机：连接到虚拟网卡VMnet1，不能与外部通信，只能和宿主机、其他连接到VMnet1的虚拟机通信

# 靶场

## Vulhub

[项目主页](https://vulhub.org/)

1. 安装Docker：`curl -s https://get.docker.com/ | sh `
2. 下载Vulhub：`git clone https://github.com/vulhub/vulhub.git`
3. 选择环境：`cd flask/ssti`
4. 启动靶场：`docker compose up -d`
5. 访问靶场：用`docker ps`查看端口号、`ip addr show`查看主机ip访问
6. 关闭靶场：`docker compose down`。为了避免被他人恶意利用，测试结束后一定记得关闭环境

过程中可能报以下错误：

- **`docker: Got permission denied`**：没有docker权限，需要执行以下命令：`sudo groupadd docker`，`sudo usermod -aG docker $USER`，`newgrp docker`
- **`unexpected keyword argument 'ssl_version'`**：使用`docker compose up -d`指令启动。不要用官方教程的`docker-compose`，那是旧版本的
- **加载超时**：docker官网被墙了，需要开代理或者换镜像站，设置方法是在`\etc\docker\daemon.json`中加入如下内容（代理或镜像选一个即可）然后重启

```json
{
  "proxies": {
    "http-proxy": "http://proxy.example.com:3128",
    "https-proxy": "https://proxy.example.com:3129",
    "no-proxy": "*.test.example.com,.example.org,127.0.0.0/8"
  }

  "registry-mirrors": ["https://mirror.com"]
}
```

## pikachu

1. 安装[小皮面板](https://www.xp.cn/product-download)（Linux），或者[phpStudy](https://www.xp.cn/php-study)（Windows）
2. 用浏览器登录面板，然后在网站和数据库界面分别安装apache和mysql
3. 下载pikachu，并复制到`/xp/www`
4. 在面板的“网站”界面选择添加网站 - 手动创建，域名随便绑一个端口，根目录`/xp/www/pikachu`（即上一步复制的目录），然后点下一步
5. 随便选个php版本，并创建MySQL数据库。将数据库账号、密码写进`config.inc.php`（位于`/xp/www/pikachu/inc`）
6. 打开网站（可在面板 - 网站点击网站名打开），访问`/install.php`，点击初始化

Y3QJUigt
